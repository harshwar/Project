<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin NFT Minter</title>
</head>
<body>
    <h1>Upload and Mint NFT</h1>
    
    <div>
        <label for="recipientAddress">Recipient Address:</label>
        <input type="text" id="recipientAddress" placeholder="0x..." size="50" />
    </div>
    <br/>
    <div>
        <label for="fileInput">NFT Image File:</label>
        <input type="file" id="fileInput" />
    </div>
    <br/>
    <button id="mintButton">Upload & Mint</button>
    <p id="status"></p>

    <script src="./ethers.umd.min.js"></script>

    <script type="module">
        import { CONTRACT_ABI } from './abi.js';

        // --- Constants & Configuration ---
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const HARDHAT_CHAIN_ID = '31337';
        const UPLOAD_SERVER_URL = 'http://localhost:3001/upload';
        
        // Helper function to update the status text in the UI
        const updateStatus = (message) => {
            document.getElementById('status').innerText = message;
        };

        // --- Core Functions ---
        const validateInputs = (address, files) => {
            if (files.length === 0) {
                alert("Please select a file!");
                return false;
            }
            if (!ethers.isAddress(address)) {
                alert("Please enter a valid recipient address!");
                return false;
            }
            return true;
        };

        const checkAndSwitchNetwork = async () => {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const { chainId } = await provider.getNetwork();

            if (chainId !== BigInt(HARDHAT_CHAIN_ID)) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: `0x${Number(HARDHAT_CHAIN_ID).toString(16)}` }],
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        alert('Please add the Hardhat network to MetaMask first!');
                    }
                    return false;
                }
            }
            return true;
        };

        const uploadFile = async (file) => {
            updateStatus("Uploading to IPFS via server...");
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(UPLOAD_SERVER_URL, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            return result.tokenURI;
        };

        const mintNFT = async (recipientAddress, tokenURI) => {
            updateStatus(`Successfully uploaded. TokenURI: ${tokenURI}. Now minting...`);

            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            try {
                const tx = await contract.safeMint(recipientAddress, tokenURI);
                updateStatus("Minting transaction sent! Waiting for confirmation...");
                await tx.wait();
                updateStatus(`NFT successfully minted to ${recipientAddress}! Tx hash: ${tx.hash}`);
            } catch (error) {
                console.error(error);
                updateStatus("Minting failed. See console for details.");
            }
        };

        // --- Main Function (Entry Point) ---
        async function uploadAndMint() {
            const recipientAddress = document.getElementById('recipientAddress').value;
            const fileInput = document.getElementById('fileInput');

            if (!validateInputs(recipientAddress, fileInput.files)) return;
            if (!await checkAndSwitchNetwork()) return;

            try {
                const tokenURI = await uploadFile(fileInput.files[0]);
                await mintNFT(recipientAddress, tokenURI);
            } catch (error) {
                console.error(error);
                updateStatus(`Error: ${error.message || "An unexpected error occurred."}`);
            }
        }

        // --- Event Listener to attach the function ---
        const mintButton = document.getElementById('mintButton');
        mintButton.addEventListener('click', uploadAndMint);
    </script>
</body>
</html>